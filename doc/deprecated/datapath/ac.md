## 地址检查器

### 原理

因为 p7 中引入了异常和中断，所以需要有一种检查地址的机制。但是，p7 里也引入了对设备的读写，而且和对 `dm` 的读写多少是统一的。所以，为了把对读写地址和模式的检查抽象出来，可以用地址检查器来实现。

### 端口定义

端口 | 类型 | 位宽 | 功能
--- | --- | --- | ---
`addr` | 输入 | 32 | 当前读写 `dm` 或 `bridge` 的地址
`dm_mode` | 输入 | 3 | 当前 `dm` 的模式
`validity` | 输出 | 3 | 当前地址在当前模式下的有效性

### 宏定义

地址检查器也使用 `dm` 和 `bridge` 的宏。

类别 | 定义 | 值 | 意义
--- | --- | --- | ---
地址有效性 | `AC_VALID` | 3'd0 | 地址有效
地址有效性 | `AC_BAD` | 3'd1 | 读取时地址无效

### 功能

若当前地址超出范围或者在当前模式下不对齐或者当前模式不适合对应的设备或者当前地址不可写，则判定为无效地址。范围按照 `dm.h` 和 `bridge.h` 中确定的值来确定。若 `write_enable == 1'b1`，则属于写入时地址无效，否则属于读取时地址无效。当前地址既不超出范围又不在当前模式下不对齐时，地址有效。按照地址有效性的各种意义在 `validity` 端口输出相应的值。

各个小条件的判断逻辑首先假定模式不是 `DM_NONE`，之后判断 `invalid` 的时候会统一判断。

### 注意

1. **地址范围要和 `bridge` 同步**
2. **如果当前地址是设备地址，则锁定模式为按字读写**
3. **地址要作为无符号数比较**
4. **如果当前模式是 `DM_NONE`，就不存在超出范围的问题了**
5. **不检查 `write_enable` 的原因是 `ac` 是组合逻辑，如果检查出错，`write_enable` 会被禁用，因此只能给 `control` 查**
6. **对设备读写不对齐是不能被原谅的，往 `timer[01]` 的 `count` 的地址范围写不行，读写模式不是字也不行**
7. **忽略判断模式是 `DM_NONE` 是为了避免各个小判断的逻辑复杂化，从而出错**

